# プロジェクトタブ表示問題修正要件

## 問題概要
プロジェクトを4つ作成しているが、4つ目のプロジェクトがタブに表示されない問題が発生している。

## 根本原因
1. `project_tab_orders`テーブルが存在しないため、プロジェクトタブの順序管理が失敗
2. `useProjectTabOrder`フックでテーブル不存在エラーが発生
3. `ProjectTabs`コンポーネントの`orderedProjects`生成処理で空配列になる
4. プロジェクト表示ロジックが順序管理に完全依存している

## 修正要件

### 1. プロジェクトタブ表示の安定性確保（優先度：高）

#### 1.1 フォールバック表示機能
- **要件**: `project_tab_orders`テーブルが存在しない場合でも全プロジェクトを表示
- **期待動作**: 順序管理に失敗してもプロジェクトタブが表示される
- **テストケース**:
  - テーブル不存在時も4つのプロジェクトすべてがタブとして表示される
  - デフォルト順序（作成日時順またはプロジェクト名順）で表示される
  - 特別タブ（直近1週間、すべて）が最初に表示される

#### 1.2 エラー耐性の向上
- **要件**: データベースエラーが発生してもプロジェクト表示を継続
- **期待動作**: エラー発生時にフォールバックロジックが動作
- **テストケース**:
  - ネットワークエラー時もプロジェクトが表示される
  - 権限エラー時もプロジェクトが表示される
  - タイムアウト時もプロジェクトが表示される

### 2. 順序管理機能の改善（優先度：中）

#### 2.1 順序管理のオプション化
- **要件**: 順序管理機能を必須から任意に変更
- **期待動作**: 順序管理が無効でも基本機能が動作
- **テストケース**:
  - 順序管理無効時もドラッグ&ドロップが適切に無効化される
  - 順序管理有効時は通常通り並び替えが可能
  - 状態変更が適切に反映される

#### 2.2 順序データの永続化改善
- **要件**: ローカルストレージでの順序保存をフォールバックとして利用
- **期待動作**: データベース保存に失敗してもローカルで順序を保持
- **テストケース**:
  - データベース保存失敗時もローカルストレージに保存される
  - ページリロード時にローカルストレージから順序を復元
  - データベース復旧時に順序が同期される

### 3. プロジェクト取得・表示ロジックの改善（優先度：中）

#### 3.1 プロジェクト表示の独立性
- **要件**: プロジェクト表示を順序管理から分離
- **期待動作**: 順序管理エラーに関係なくプロジェクトが表示
- **テストケース**:
  - 順序管理エラー時もプロジェクト数が正確
  - プロジェクト名とIDが正しく表示される
  - プロジェクト色が適切に適用される

#### 3.2 動的プロジェクト追加の対応
- **要件**: 新規プロジェクト追加時の自動タブ表示
- **期待動作**: リアルタイムでタブが追加・更新される
- **テストケース**:
  - 新規プロジェクト作成時にタブが自動追加
  - プロジェクト削除時にタブが自動削除
  - プロジェクト更新時にタブが自動更新

### 4. テストカバレッジ要件（優先度：高）

#### 4.1 エラーシナリオのテスト
- データベーステーブル不存在
- ネットワーク接続エラー
- 権限不足エラー
- データ破損・不整合

#### 4.2 プロジェクト数バリエーションのテスト
- プロジェクト0個の場合
- プロジェクト1個の場合  
- プロジェクト4個の場合（現在の問題ケース）
- プロジェクト10個以上の場合

#### 4.3 順序管理機能のテスト
- 正常な並び替え
- エラー時のフォールバック
- ローカルストレージ保存・復元
- データベース同期

## 実装優先順位

### Phase 1: 緊急修正（Red Phase）
1. プロジェクトタブ表示の失敗テスト作成
2. 4つのプロジェクトが表示されることのテスト

### Phase 2: フォールバック実装（Green Phase）
1. 順序管理エラー時のフォールバック実装
2. プロジェクト表示の独立化
3. エラーハンドリング改善

### Phase 3: 機能改善（Refactor Phase）
1. 順序管理のオプション化
2. ローカルストレージ活用
3. リアルタイム更新対応

## 成功基準

### 必須要件
- ✅ 4つのプロジェクトすべてがタブに表示される
- ✅ `project_tab_orders`テーブル不存在でもエラーが発生しない
- ✅ プロジェクト追加・削除・更新が即座に反映される

### 推奨要件
- ✅ 順序管理が正常時は並び替え機能が動作
- ✅ エラー時も基本機能（タブ切り替え、フィルタ）が動作
- ✅ パフォーマンスが劣化しない

## 技術的制約

### 互換性
- 既存のプロジェクトデータ形式を維持
- 既存のコンポーネントAPIを維持
- Supabaseのスキーマ変更は最小限に抑制

### パフォーマンス
- プロジェクト数増加時の表示速度維持
- メモリ使用量の最適化
- 不要な再レンダリング防止

この要件定義に基づいて、TDDサイクル（Red → Green → Refactor）で実装を進めていきます。